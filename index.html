<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAC File Editor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        .container {
            max-width: 90%;
            margin: auto;
        }
        textarea {
            min-height: 500px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center">
    <div class="container bg-white p-8 rounded-xl shadow-lg my-10 w-full lg:w-4/5">
        <header class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">PAC File Editor</h1>
            <div id="auth-controls" class="flex space-x-2">
                <button id="login-button" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                    Login
                </button>
                <button id="logout-button" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-red-600 transition-colors hidden">
                    Logout
                </button>
            </div>
        </header>

        <main id="editor-section" class="hidden">
            <div class="mb-4">
                <label for="file-select" class="block text-gray-700 font-medium mb-2">PAC File Name</label>
                <input type="text" id="file-input" value="proxy.pac" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="mb-4 flex space-x-4">
                <button id="load-button" class="flex-1 bg-green-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-colors">
                    Load PAC File
                </button>
                <button id="save-button" class="flex-1 bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-600 transition-colors">
                    Save PAC File
                </button>
            </div>

            <div class="mb-4">
                <label for="pac-content" class="block text-gray-700 font-medium mb-2">File Content</label>
                <textarea id="pac-content" class="w-full p-4 border rounded-lg font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <div id="status-message" class="mt-4 p-4 text-center text-sm rounded-lg"></div>
        </main>

        <div id="loading-spinner" class="hidden text-center">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-500 rounded-full"></div>
            <p class="mt-2 text-gray-600">Loading...</p>
        </div>
    </div>

    <!-- Okta Auth SDK -->
    <script src="https://global.oktacdn.com/okta-auth-js/7.5.0/okta-auth-js.min.js"></script>
    <!-- Azure Storage Blob SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/storage-blob@12.18.0/dist/storage-blob.min.js"></script>

    <script>
        // --- Okta and Azure Configuration (Update these values) ---
        const oktaConfig = {
            issuer: "https://trial-5559182-admin.okta.com/oauth2/default", // e.g., https://dev-12345678.okta.com/oauth2/default
            clientId: "0oatrmih90Qjq0HF0697", // e.g., 0oanx1234567890abcdef
            redirectUri: window.location.origin + "/callback"
        };

        const azureConfig = {
            // Replace with your Azure Storage Account name
            accountName: "mypacfilestorage",
            // Hard-coded SAS token for demonstration.
            // In production, this should be generated on a serverless function and fetched by the client.
            sasToken: "sv=2024-11-04&ss=bfqt&srt=sco&sp=rwdlacupiytfx&se=2025-08-15T02:53:02Z&st=2025-07-31T18:38:02Z&spr=https&sig=jCJYMwx28%2Fj%2FXOQ2r2VrDj%2BXDgLwvG%2BWUzZpiaqsA5c%3D"
        };

        // --- DOM Elements ---
        const loginBtn = document.getElementById('login-button');
        const logoutBtn = document.getElementById('logout-button');
        const editorSection = document.getElementById('editor-section');
        const loadBtn = document.getElementById('load-button');
        const saveBtn = document.getElementById('save-button');
        const pacContentTextArea = document.getElementById('pac-content');
        const fileInput = document.getElementById('file-input');
        const statusMessage = document.getElementById('status-message');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- Okta Auth Client ---
        const oktaAuth = new okta.Auth(oktaConfig);

        // --- Event Handlers ---
        loginBtn.addEventListener('click', () => oktaAuth.signInWithRedirect());
        logoutBtn.addEventListener('click', () => oktaAuth.signOut());
        loadBtn.addEventListener('click', loadPacFile);
        saveBtn.addEventListener('click', savePacFile);

        // --- Core Functions ---

        async function handleAuth() {
            try {
                const isAuthenticated = await oktaAuth.isAuthenticated();
                if (isAuthenticated) {
                    await handleAuthenticatedState();
                } else {
                    await handleUnauthenticatedState();
                }
            } catch (error) {
                console.error("Authentication check failed:", error);
                await handleUnauthenticatedState();
            }
        }

        async function handleAuthenticatedState() {
            loginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            editorSection.classList.remove('hidden');
            showMessage('Authenticated successfully!', 'bg-green-100 text-green-700');
        }

        async function handleUnauthenticatedState() {
            loginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            editorSection.classList.add('hidden');
            showMessage('Please log in to access the PAC file editor.', 'bg-yellow-100 text-yellow-700');
            // If the URL contains an Okta callback, process it
            if (oktaAuth.isRedirect()) {
                await oktaAuth.handleRedirect();
            }
        }

        function showMessage(message, style) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-4 p-4 text-center text-sm rounded-lg ${style}`;
        }

        function toggleLoading(isLoading) {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                editorSection.classList.add('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
                editorSection.classList.remove('hidden');
            }
        }

        async function loadPacFile() {
            const fileName = fileInput.value;
            if (!fileName) {
                showMessage('Please enter a file name.', 'bg-red-100 text-red-700');
                return;
            }
            toggleLoading(true);

            try {
                const blobServiceClient = new azblob.BlobServiceClient(`https://${azureConfig.accountName}.blob.core.windows.net?${azureConfig.sasToken}`);
                const containerClient = blobServiceClient.getContainerClient('pacfiles');
                const blobClient = containerClient.getBlobClient(fileName);

                const downloadBlockBlobResponse = await blobClient.downloadToBuffer();
                const fileContent = new TextDecoder().decode(downloadBlockBlobResponse);
                pacContentTextArea.value = fileContent;

                showMessage(`Successfully loaded '${fileName}'.`, 'bg-green-100 text-green-700');
            } catch (error) {
                console.error('Error loading file:', error);
                showMessage(`Error loading file: ${error.message}`, 'bg-red-100 text-red-700');
            } finally {
                toggleLoading(false);
            }
        }

        async function savePacFile() {
            const fileName = fileInput.value;
            const fileContent = pacContentTextArea.value;
            if (!fileName || !fileContent) {
                showMessage('Please enter a file name and content.', 'bg-red-100 text-red-700');
                return;
            }
            toggleLoading(true);

            try {
                const blobServiceClient = new azblob.BlobServiceClient(`https://${azureConfig.accountName}.blob.core.windows.net?${azureConfig.sasToken}`);
                const containerClient = blobServiceClient.getContainerClient('pacfiles');
                const blockBlobClient = containerClient.getBlockBlobClient(fileName);

                await blockBlobClient.upload(fileContent, fileContent.length);

                showMessage(`Successfully saved '${fileName}'.`, 'bg-green-100 text-green-700');
            } catch (error) {
                console.error('Error saving file:', error);
                showMessage(`Error saving file: ${error.message}`, 'bg-red-100 text-red-700');
            } finally {
                toggleLoading(false);
            }
        }

        // --- Main Execution Block ---
        window.onload = () => {
            handleAuth();
        };

    </script>
</body>
</html>
