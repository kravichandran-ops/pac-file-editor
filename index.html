<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PAC File Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
    }
    textarea {
      min-height: 400px;
      font-family: monospace;
      resize: vertical;
    }
  </style>
</head>
<body class="pt-24 flex items-center justify-center min-h-screen p-4 bg-gray-100">
  
  <!-- Fixed Header Bar -->
  <header class="w-full bg-gray-800 text-white shadow-md px-6 py-4 flex justify-between items-center fixed top-0 left-0 right-0 z-50">
    <div class="text-xl font-semibold">PAC File Editor</div>
    <div id="header-right-section" class="hidden flex items-center space-x-4">
      <span id="userName" class="text-sm md:inline"></span>
      <button id="signOutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded transition duration-300 ease-in-out text-sm">
        Sign Out
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container max-w-3xl bg-white shadow-lg rounded-xl p-8 space-y-6 w-full">
    
    <!-- Auth Section -->
    <div id="auth-section" class="flex flex-col items-center space-y-4">
      <p id="auth-status" class="text-lg text-gray-600">Please sign in to continue.</p>
      <button id="signInButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
        Sign In
      </button>
    </div>

    <!-- Editor Section -->
    <div id="editor-section" class="hidden space-y-4">
      <div class="mb-4">
        <label for="pac-file-select" class="block text-gray-700 text-sm font-bold mb-2">Select PAC File:</label>
        <select id="pac-file-select" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option selected>Select PAC File</option>
        </select>          
      </div>

      <textarea id="pacFileContent" class="shadow-inner appearance-none border rounded-lg w-full p-3 text-gray-800 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>

      <div class="flex justify-end space-x-4">
        <button id="deleteButton" disabled class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 disabled:opacity-20">
          Delete PAC File
        </button>
        <button id="saveButton" disabled class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 disabled:opacity-20">
          Update PAC File
        </button>
      </div>

      <div id="messageBox" class="hidden p-4 rounded-lg text-center text-sm font-medium" role="alert"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const msalConfig = {
      auth: {
        clientId: "5b3b1e17-61d5-4511-b90f-89a82f6634f9",
        authority: "https://login.microsoftonline.com/e2bc7536-68e6-4af0-b6d4-72a547453091",
        redirectUri: window.location.origin + "/.auth/login/aad/callback"
      },
      cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginRequest = { scopes: ["User.Read"] };

    const authSection = document.getElementById('auth-section');
    const editorSection = document.getElementById('editor-section');
    const signInButton = document.getElementById('signInButton');
    const signOutButton = document.getElementById('signOutButton');
    const userNameSpan = document.getElementById('userName');
    const authStatus = document.getElementById('auth-status');
    const pacFileContentTextarea = document.getElementById('pacFileContent');
    const deleteButton = document.getElementById('deleteButton');
    const saveButton = document.getElementById('saveButton');
    const messageBox = document.getElementById('messageBox');
    const pacFileSelector = document.getElementById('pac-file-select');
    const headerRightSection = document.getElementById('header-right-section');

    function showMessage(message, type = 'info') {
      messageBox.textContent = message;
      messageBox.className = 'p-4 rounded-lg text-center text-sm font-medium';

      if (type === 'error') {
        messageBox.classList.add('bg-red-100', 'text-red-700');
      } else if (type === 'success') {
        messageBox.classList.add('bg-green-100', 'text-green-700');
      } else {
        messageBox.classList.add('bg-blue-100', 'text-blue-700');
      }

      messageBox.classList.remove('hidden');
      setTimeout(() => messageBox.classList.add('hidden'), 5000);
    }

    async function signIn() {
      try {
        await msalInstance.loginPopup(loginRequest);
        checkAccountAndRenderUI();
      } catch (error) {
        console.error("Login failed:", error);
        showMessage("Login failed. Please try again.", "error");
      }
    }

    async function signOut() {
      try {
        await msalInstance.logoutPopup();
        authSection.classList.remove('hidden');
        editorSection.classList.add('hidden');
        headerRightSection.classList.add('hidden');
        userNameSpan.textContent = "";
        pacFileContentTextarea.value = "";
        showMessage("Successfully signed out.", "success");
      } catch (error) {
        console.error("Logout failed:", error);
        showMessage("Logout failed. Please try again.", "error");
      }
    }

    async function checkAccountAndRenderUI() {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        const account = accounts[0];
        authSection.classList.add('hidden');
        editorSection.classList.remove('hidden');
        headerRightSection.classList.remove('hidden');
        userNameSpan.textContent = account.username;
        // authStatus.textContent = "Authenticated.";
        showMessage("Welcome, " + account.username + "!", "info");
        await listPacFiles();
      } else {
        authSection.classList.remove('hidden');
        editorSection.classList.add('hidden');
        headerRightSection.classList.add('hidden');
      }
    }

    async function listPacFiles() {
      showMessage("Fetching PAC file list...", "info");
      try {
        const response = await fetch("/api/ListPacFile");
        const result = await response.json();

        if (Array.isArray(result.files)) {
          pacFileSelector.length = 1;
          result.files.forEach(file => {
            const option = document.createElement("option");
            option.value = file;
            option.textContent = file;
            pacFileSelector.appendChild(option);
          });
          showMessage(`Found ${result.files.length} file(s).`, "success");
        } else {
          throw new Error("Invalid response format.");
        }
      } catch (error) {
        console.error("Error:", error);
        showMessage("Error listing PAC files: " + error.message, "error");
      }
    }

    async function loadPacFile(fileName) {
      if (!fileName) {
        showMessage("Please select a PAC file.", "error");
        return;
      }

      showMessage("Loading PAC file...", "info");
      try {
        const response = await fetch(`/api/GetPacFile?name=${encodeURIComponent(fileName)}`);
        if (response.ok) {
          pacFileContentTextarea.value = await response.text();
          showMessage(`PAC file '${fileName}' loaded.`, "success");
        } else {
          const errorText = await response.text();
          showMessage(`Failed to load PAC file: ${errorText}`, "error");
        }
      } catch (error) {
        showMessage("Error loading PAC file: " + error.message, "error");
      }
    }

    async function savePacFile() {
      const fileName = pacFileSelector.value.trim();
      const content = pacFileContentTextarea.value;

      if (!fileName) {
        showMessage("Please select a PAC file name.", "error");
        return;
      }

      showMessage("Saving PAC file...", "info");
      try {
        const response = await fetch(`/api/SavePacFile?name=${encodeURIComponent(fileName)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: content
        });

        if (response.ok) {
          const msg = await response.text();
          showMessage(msg, "success");
        } else {
          showMessage(`Failed to save PAC file: ${await response.text()}`, "error");
        }
      } catch (error) {
        showMessage("Error saving PAC file: " + error.message, "error");
      }
    }

    async function deletePacFile() {
      const fileName = pacFileSelector?.value?.trim();
      if (!fileName) {
        showMessage("Please select a PAC file to delete.", "error");
        return;
      }

      if (!confirm(`Are you sure you want to delete '${fileName}'?`)) return;

      showMessage("Deleting PAC file...", "info");

      try {
        const response = await fetch(`/api/DeletePacFile?name=${encodeURIComponent(fileName)}`, { method: 'DELETE' });

        if (response.ok) {
          pacFileContentTextarea.value = "";
          const option = pacFileSelector.querySelector(`option[value="${fileName}"]`);
          if (option) option.remove();
          showMessage(`Deleted '${fileName}' successfully.`, "success");
        } else {
          showMessage(`Failed to delete PAC file: ${await response.text()}`, "error");
        }
      } catch (error) {
        showMessage("Error deleting PAC file: " + error.message, "error");
      }
    }

    // Event Listeners
    signInButton.addEventListener('click', signIn);
    signOutButton?.addEventListener('click', signOut);
    deleteButton.addEventListener('click', deletePacFile);
    saveButton.addEventListener('click', savePacFile);
    pacFileSelector.addEventListener('change', () => {
      const file = pacFileSelector.value;
      if (file && file !== "Select PAC File") {
        loadPacFile(file);

        deleteButton.disabled = false;
        saveButton.disabled = false;
      } else {
        pacFileContentTextarea.value = "";
        deleteButton.disabled = true;
        saveButton.disabled = true;
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
        // Reset textarea and disable buttons
        pacFileContentTextarea.value = "";
        deleteButton.disabled = true;
        saveButton.disabled = true;
    });

    // Init
    msalInstance.handleRedirectPromise().then(checkAccountAndRenderUI).catch(console.error);
    checkAccountAndRenderUI();
  </script>
</body>
</html>
